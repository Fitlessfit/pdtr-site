RewriteEngine On

ErrorDocument 404 /404.php

# явно исключаем API-эндпоинты из перезаписи (корневые)
RewriteRule ^(main_handler)\.php$ - [L]

# ”бираем .php из URL (кроме спец-скриптов)
RewriteCond %{THE_REQUEST} ^[A-Z]{3,}\s([^.]+)\.php [NC]
RewriteCond %1 !^(main_handler)$ [NC]
RewriteRule ^ %1 [R=301,L]

# ¬нутреннее перенаправление на файл .php (если он существует)
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME}.php -f
RewriteRule ^(.*?)/?$ $1.php [L]